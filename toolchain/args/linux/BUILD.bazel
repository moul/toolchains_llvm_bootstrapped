
load("@rules_cc//cc/toolchains:args.bzl", "cc_args")
load("@rules_cc//cc/toolchains:actions.bzl", "cc_action_type_set")

package(default_visibility = ["//visibility:public"])

# Extracted from rules_cc unix_cc_configure.bzl
# TODO(cerisier): Extract those into proper semantic args list.
cc_args(
    name = "default_link_flags",
    actions = [
        "@rules_cc//cc/toolchains/actions:link_actions",
    ],
    args = [
        "-Wl,-no-as-needed",
        "-Wl,-z,relro,-z,now",
    ],
)

cc_args(
    name = "kernel_headers_include_search_paths",
    actions = [
        "@rules_cc//cc/toolchains/actions:source_compile_actions",
    ],
    args = [
        "-isystem",
        "{kernel_headers_include_search_path}",
    ],
    format = {
        "kernel_headers_include_search_path": "@kernel_headers//:kernel_headers_directory",
    },
    allowlist_include_directories = [
        "@kernel_headers//:kernel_headers_directory",
    ],
    data = [
        "@kernel_headers//:kernel_headers_directory",
    ],
)

cc_args(
    name = "glibc_headers_include_search_paths",
    actions = [
        "@rules_cc//cc/toolchains/actions:source_compile_actions",
    ],
    args = [
        # "__GLIBC_MINOR__={d}", version.minor
        "-isystem",
        "{libc_headers_include_search_path}",
    ],
    format = {
        "libc_headers_include_search_path": "//runtimes/glibc:glibc_headers_include_search_directory",
    },
    allowlist_include_directories = [
        "//runtimes/glibc:glibc_headers_include_search_directory",
    ],
    data = [
        "//runtimes/glibc:glibc_headers_include_search_directory",
    ],
)

cc_args(
    name = "sanitizer_headers_include_search_paths",
    actions = [
        "@rules_cc//cc/toolchains/actions:source_compile_actions",
    ],
    args = [
        "-isystem",
        "{sanitizer_headers_include_search_paths}",
    ],
    format = {
        "sanitizer_headers_include_search_paths": "//sanitizers:sanitizers_headers_include_search_directory",
    },
    allowlist_include_directories = [
        "//sanitizers:sanitizers_headers_include_search_directory",
    ],
    data = [
        "//sanitizers:sanitizers_headers_include_search_directory",
    ],
)

cc_args(
    name = "default_libs_gnu",
    actions = [
        "@rules_cc//cc/toolchains/actions:link_actions",
    ],
    args = [
        # We need to support copts like -lc -ldl etc...
        "-L{libc_library_search_path}",

        # In prevention of when all of those can be shared libraries.
        "-Wl,--push-state",
        "-Wl,--as-needed",

        # Since libunwind is linked statically, we need to link pthread as well.
        "-lpthread",
        # Since libunwind is linked statically, we need to link dl as well.
        "-ldl",

        "-Wl,--pop-state",
    ],
    data = [
        "//runtimes/glibc:glibc_library_search_directory",
    ],
    format = {
        "libc_library_search_path": "//runtimes/glibc:glibc_library_search_directory",
    },
)

###

cc_args(
    name = "musl_libc_headers_include_search_paths",
    actions = [
        "@rules_cc//cc/toolchains/actions:source_compile_actions",
    ],
    args = [
        "-isystem",
        "{libc_headers_include_search_path}",
    ],
    format = {
        "libc_headers_include_search_path": "//runtimes/musl:musl_headers_include_search_directory",
    },
    data = [
        "//runtimes/musl:musl_headers_include_search_directory",
    ],
)

#TODO: Factorize this and gnu
cc_args(
    name = "default_libs_musl",
    actions = [
        "@rules_cc//cc/toolchains/actions:link_actions",
    ],
    args = [
        # We need to support copts like -lc -ldl etc...
        "-L{libc_library_search_path}",

        # In prevention of when all of those can be shared libraries.
        "-Wl,--push-state",
        "-Wl,--as-needed",

        # Since libunwind is linked statically, we need to link pthread as well.
        "-lpthread",
        # Since libunwind is linked statically, we need to link dl as well.
        "-ldl",

        "-Wl,--pop-state",
    ],
    data = [
        "//runtimes/musl:musl_library_search_directory",
    ],
    format = {
        "libc_library_search_path": "//runtimes/musl:musl_library_search_directory",
    },
)

alias(
    name = "default_libs",
    actual = select({
        "//platforms/config:musl": ":default_libs_musl",
        "//platforms/config:gnu": ":default_libs_gnu",
    }),
)
